import os
import subprocess

# ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ DATABASE_URL
os.environ['DATABASE_URL'] = 'postgresql+psycopg2://sarmad:Sarmad0af2400@127.0.0.1:5432/vpn_bot'

# Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Alembic
alembic_config = 'vpn_bot/db/migrations/alembic.ini'

# Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± alembic upgrade head
try:
    print("ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ù‡Ø§Ø¬Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ Alembic...")
    subprocess.run(['alembic', '-c', alembic_config, 'upgrade', 'head'], check=True)
    print("âœ… Ù…Ù‡Ø§Ø¬Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.")
except subprocess.CalledProcessError as e:
    print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ù…Ù‡Ø§Ø¬Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: {e}")
    exit(1)

# Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯
db_name = 'vpn_bot'
db_user = 'postgres'
try:
    print(f"ğŸ”„ Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯: {db_name}...")
    subprocess.run(['createdb', '-h', 'localhost', '-p', '5432', '-U', db_user, db_name], check=True)
    print(f"âœ… Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ {db_name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯.")
except subprocess.CalledProcessError as e:
    print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: {e}")
    exit(1)

# Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª seedall
try:
    print("ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª seedall Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...")
    subprocess.run(['python', '-m', 'vpn_bot.db.manage', 'seedall'], check=True)
    print("âœ… Ø§Ø³Ú©Ø±ÛŒÙ¾Øª seedall Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯.")
except subprocess.CalledProcessError as e:
    print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª seedall: {e}")
    exit(1)
